This case study has four area of focus.
*Pizza Metrics
*Runner and Customer Experience
*Ingredient Optimisation
*Pricing and Ratings


#### PRICE METRICS
1. How many pizzas were ordered?

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codes</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p>This case study has four area of focus.<br>
*Pizza Metrics<br>
*Runner and Customer Experience<br>
*Ingredient Optimisation<br>
*Pricing and Ratings</p>
<p>PRICE METRICS</p>
<ol>
<li>How many pizzas were ordered?</li>
</ol>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span>
pizza_runner<span class="token punctuation">.</span>customer_orders<span class="token punctuation">;</span><span class="token punctuation">`</span><span class="token punctuation">`</span><span class="token punctuation">`</span>

<span class="token number">2</span><span class="token punctuation">.</span> How many <span class="token keyword">unique</span> customer orders were made?
<span class="token keyword">SELECT</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> customer_id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders<span class="token punctuation">;</span>

<span class="token number">3</span><span class="token punctuation">.</span> How many <span class="token keyword">of</span> each <span class="token keyword">type</span> <span class="token keyword">of</span> pizza was delivered?
<span class="token keyword">SELECT</span>
  pizza_name<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>customer_orders<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> delivered_order_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>order_id <span class="token operator">=</span> runner_orders<span class="token punctuation">.</span>order_id
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>pizza_names <span class="token keyword">ON</span> pizza_names<span class="token punctuation">.</span>pizza_id <span class="token operator">=</span> customer_orders<span class="token punctuation">.</span>pizza_id
<span class="token keyword">WHERE</span>
  cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
    <span class="token string">'Customer Cancellation'</span>
  <span class="token punctuation">)</span>
  <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  pizza_name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  delivered_order_count <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token number">4</span><span class="token punctuation">.</span>  How many successful orders were delivered <span class="token keyword">by</span> each runner?
<span class="token keyword">SELECT</span>
  runner_id<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> successful_orders
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>runner_orders
<span class="token keyword">WHERE</span>
  cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
    <span class="token string">'Customer Cancellation'</span>
  <span class="token punctuation">)</span> <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  runner_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  successful_orders <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token number">5</span><span class="token punctuation">.</span>  How many <span class="token keyword">of</span> each <span class="token keyword">type</span> <span class="token keyword">of</span> pizza was ordered?
<span class="token keyword">CREATE</span> <span class="token keyword">TEMP</span> <span class="token keyword">TABLE</span> ordered_pizza_type <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
  customer_orders<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span>
  customer_orders<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
  pizza_names<span class="token punctuation">.</span>pizza_id<span class="token punctuation">,</span>
  pizza_names<span class="token punctuation">.</span>pizza_name
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>pizza_names <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>pizza_id <span class="token operator">=</span> pizza_names<span class="token punctuation">.</span>pizza_id 
  <span class="token keyword">SELECT</span>
    pizza_name<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> type_count
  <span class="token keyword">FROM</span>
    ordered_pizza_type
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    pizza_name<span class="token punctuation">;</span>

<span class="token operator">OR</span>
<span class="token keyword">SELECT</span>
  pizza_name<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> type_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>pizza_names <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>pizza_id <span class="token operator">=</span> pizza_names<span class="token punctuation">.</span>pizza_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  pizza_name<span class="token punctuation">;</span>
  
<span class="token number">6</span><span class="token punctuation">.</span>  How many Vegetarian <span class="token operator">and</span> Meatlovers were ordered <span class="token keyword">by</span> each customer?  
<span class="token comment">--from the temporary table created above, we can query to get the count SELECT</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> type_count
<span class="token keyword">FROM</span>
  ordered_pizza_type
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name<span class="token punctuation">;</span>

<span class="token operator">OR</span>

<span class="token comment">-- join tables and query together</span>

<span class="token keyword">SELECT</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> type_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>pizza_names <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>pizza_id <span class="token operator">=</span> pizza_names<span class="token punctuation">.</span>pizza_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  customer_id<span class="token punctuation">,</span>
  pizza_name<span class="token punctuation">;</span>
  
<span class="token number">7</span><span class="token punctuation">.</span> What was the maximum number <span class="token keyword">of</span> pizzas delivered <span class="token operator">in</span> <span class="token number">a</span> single <span class="token keyword">order</span>?
<span class="token keyword">WITH</span> max_delivered_order <span class="token keyword">AS</span><span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    customer_id<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>customer_orders<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> successful_orders
  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>customer_orders
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>order_id <span class="token operator">=</span> runner_orders<span class="token punctuation">.</span>order_id
  <span class="token keyword">WHERE</span>
    cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
      <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
      <span class="token string">'Customer Cancellation'</span>
    <span class="token punctuation">)</span>
    <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    customer_id
  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    successful_orders <span class="token keyword">DESC</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  <span class="token function">MAX</span><span class="token punctuation">(</span>successful_orders<span class="token punctuation">)</span>
<span class="token keyword">FROM</span>
  max_delivered_order<span class="token punctuation">;</span>
  
<span class="token number">8</span><span class="token punctuation">.</span>  <span class="token keyword">For</span> each customer<span class="token punctuation">,</span> how many delivered pizzas had at least <span class="token number">1</span> change <span class="token operator">and</span> how many had <span class="token keyword">no</span> changes?

<span class="token keyword">WITH</span> delivered_pizza <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>customer_orders
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>order_id <span class="token operator">=</span> runner_orders<span class="token punctuation">.</span>order_id
  <span class="token keyword">WHERE</span>
    cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
      <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
      <span class="token string">'Customer Cancellation'</span>
    <span class="token punctuation">)</span>
    <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
updated_extras_and_exclusions <span class="token keyword">AS</span><span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    customer_id<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> exclusions <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'null'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token boolean">NULL</span>
      <span class="token keyword">ELSE</span> exclusions
    <span class="token keyword">END</span> <span class="token keyword">AS</span> updated_exclusions<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> extras <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'null'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token boolean">NULL</span>
      <span class="token keyword">ELSE</span> extras
    <span class="token keyword">END</span> <span class="token keyword">AS</span> updated_extras
  <span class="token keyword">FROM</span>
    delivered_pizza
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  customer_id<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> updated_exclusions <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
      <span class="token operator">OR</span> updated_extras <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span>
      <span class="token keyword">ELSE</span> <span class="token number">0</span>
    <span class="token keyword">END</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> at_least_1_change<span class="token punctuation">,</span>
  <span class="token function">SUM</span><span class="token punctuation">(</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> updated_exclusions <span class="token operator">IS</span> <span class="token boolean">NULL</span>
      <span class="token operator">AND</span> updated_extras <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span>
      <span class="token keyword">ELSE</span> <span class="token number">0</span>
    <span class="token keyword">END</span>
  <span class="token punctuation">)</span> <span class="token keyword">AS</span> no_changes
<span class="token keyword">FROM</span>
  updated_extras_and_exclusions
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  customer_id<span class="token punctuation">;</span>

<span class="token number">9</span><span class="token punctuation">.</span>  How many pizzas were delivered that had both exclusions <span class="token operator">and</span> extras?
 
<span class="token keyword">WITH</span> delivered_pizza <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>  <span class="token operator">*</span>  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>customer_orders
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">ON</span> customer_orders<span class="token punctuation">.</span>order_id <span class="token operator">=</span> runner_orders<span class="token punctuation">.</span>order_id
  <span class="token keyword">WHERE</span>
    cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
      <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
      <span class="token string">'Customer Cancellation'</span>
    <span class="token punctuation">)</span>
    <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
updated_extras_and_exclusions <span class="token keyword">AS</span><span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    customer_id<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> exclusions <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'null'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token boolean">NULL</span>
      <span class="token keyword">ELSE</span> exclusions
    <span class="token keyword">END</span> <span class="token keyword">AS</span> updated_exclusions<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
      <span class="token keyword">WHEN</span> extras <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'null'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token boolean">NULL</span>
      <span class="token keyword">ELSE</span> extras
    <span class="token keyword">END</span> <span class="token keyword">AS</span> updated_extras
  <span class="token keyword">FROM</span>
    delivered_pizza
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> updated_extras_and_exclusions
  <span class="token keyword">WHERE</span> updated_exclusions <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> updated_extras <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
   
<span class="token number">10</span><span class="token punctuation">.</span>  What was the total volume <span class="token keyword">of</span> pizzas ordered <span class="token keyword">for</span> each hour <span class="token keyword">of</span> the day?
<span class="token keyword">SELECT</span>
  DATE_PART<span class="token punctuation">(</span><span class="token string">'hour'</span><span class="token punctuation">,</span> order_time :: <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span> <span class="token keyword">as</span> hour_of_the_day<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>pizza_id<span class="token punctuation">)</span> <span class="token keyword">as</span> pizza_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  hour_of_the_day
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  hour_of_the_day<span class="token punctuation">;</span>
  
<span class="token number">11</span><span class="token punctuation">.</span>  What was the volume <span class="token keyword">of</span> orders <span class="token keyword">for</span> each day <span class="token keyword">of</span> the week?
<span class="token keyword">SELECT</span>
  TO_CHAR<span class="token punctuation">(</span>order_time :: <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span><span class="token string">'DAY'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> weekday<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>pizza_id<span class="token punctuation">)</span> <span class="token keyword">as</span> pizza_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>customer_orders
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  weekday
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
 weekday<span class="token punctuation">;</span>



RUNNER <span class="token operator">AND</span> CUSTOMER EXPERIENCE
<span class="token number">12</span><span class="token punctuation">.</span>  How many runners signed up <span class="token keyword">for</span> each <span class="token number">1</span> week period? <span class="token punctuation">(</span>i<span class="token number">.e</span><span class="token punctuation">.</span> week starts  <span class="token punctuation">`</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">`</span><span class="token punctuation">)</span>

<span class="token keyword">SELECT</span>
  DATE_TRUNC<span class="token punctuation">(</span><span class="token string">'week'</span><span class="token punctuation">,</span> registration_date<span class="token punctuation">)</span> :: <span class="token keyword">DATE</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token keyword">AS</span> registration_week<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> runner
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>runners
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  registration_week<span class="token punctuation">;</span>
   
<span class="token number">13</span><span class="token punctuation">.</span>  What was the average time <span class="token operator">in</span> minutes it took <span class="token keyword">for</span> each runner <span class="token keyword">to</span> arrive at the Pizza Runner HQ <span class="token keyword">to</span> pickup the <span class="token keyword">order</span>?

<span class="token keyword">WITH</span> cte <span class="token keyword">AS</span><span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    runner_id<span class="token punctuation">,</span>
    EXTRACT<span class="token punctuation">(</span>
      EPOCH
      <span class="token keyword">FROM</span>
        <span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>pickup_time <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> pickup_time<span class="token punctuation">,</span>
    EXTRACT<span class="token punctuation">(</span>
      EPOCH
      <span class="token keyword">FROM</span>
        <span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>order_time <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> order_time
  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>runner_orders
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>customer_orders <span class="token keyword">ON</span> runner_orders<span class="token punctuation">.</span>order_id <span class="token operator">=</span> customer_orders<span class="token punctuation">.</span>order_id
  <span class="token keyword">WHERE</span>
    pickup_time <span class="token operator">!=</span> <span class="token string">'null'</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  runner_id<span class="token punctuation">,</span>
  <span class="token function">AVG</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pickup_time <span class="token operator">-</span> order_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_pickup_time
<span class="token keyword">FROM</span>
  cte
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  runner_id<span class="token punctuation">;</span>
  
<span class="token number">14</span><span class="token punctuation">.</span>  <span class="token operator">Is</span> there <span class="token keyword">any</span> relationship <span class="token operator">between</span> the number <span class="token keyword">of</span> pizzas <span class="token operator">and</span> how long the <span class="token keyword">order</span> takes <span class="token keyword">to</span> prepare?

<span class="token keyword">SELECT</span>
  <span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
  DATE_PART<span class="token punctuation">(</span>
    <span class="token string">'minute'</span><span class="token punctuation">,</span>
    AGE<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>pickup_time :: <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span> t2<span class="token punctuation">.</span>order_time<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> :: <span class="token keyword">INTEGER</span> <span class="token keyword">AS</span> pickup_minutes<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span>t2<span class="token punctuation">.</span>order_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> pizza_count
<span class="token keyword">FROM</span>
  pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">AS</span> t1
  <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>customer_orders <span class="token keyword">AS</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>order_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>order_id
<span class="token keyword">WHERE</span>
  t1<span class="token punctuation">.</span>pickup_time <span class="token operator">!=</span> <span class="token string">'null'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  t1<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
  pickup_minutes
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  pizza_count<span class="token punctuation">;</span>


<span class="token number">15</span><span class="token punctuation">.</span>  What was the average distance travelled <span class="token keyword">for</span> each customer? 

<span class="token keyword">WITH</span> order_distances <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span>
  t1<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span>
  t1<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
  UNNEST<span class="token punctuation">(</span>REGEXP_MATCH<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token string">'(^[0-9,.]+)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>::<span class="token keyword">NUMERIC</span> <span class="token keyword">AS</span> distance
<span class="token keyword">FROM</span> pizza_runner<span class="token punctuation">.</span>customer_orders <span class="token keyword">AS</span> t1
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">AS</span> t2
  <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>order_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>order_id
<span class="token keyword">WHERE</span> t2<span class="token punctuation">.</span>pickup_time <span class="token operator">!=</span> <span class="token string">'null'</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  customer_id<span class="token punctuation">,</span>
  <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_distance
<span class="token keyword">FROM</span> order_distances
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customer_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> customer_id<span class="token punctuation">;</span>


<span class="token number">16</span><span class="token punctuation">.</span>  What was the difference <span class="token operator">between</span> the longest <span class="token operator">and</span> shortest delivery times <span class="token keyword">for</span> <span class="token keyword">all</span> orders?

<span class="token keyword">WITH</span> delivery_duration <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    UNNEST<span class="token punctuation">(</span>REGEXP_MATCH<span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token string">'(^[0-9]+)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> :: <span class="token keyword">NUMERIC</span> <span class="token keyword">AS</span> duration
  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>runner_orders
  <span class="token keyword">WHERE</span>
    duration <span class="token operator">!=</span> <span class="token string">'null'</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  <span class="token function">MAX</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">MIN</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token keyword">AS</span> delivery_distance
<span class="token keyword">FROM</span>
  delivery_duration
  
<span class="token number">17</span><span class="token punctuation">.</span>  What was the average speed <span class="token keyword">for</span> each runner <span class="token keyword">for</span> each delivery <span class="token operator">and</span> <span class="token keyword">do</span> you notice <span class="token keyword">any</span> trend <span class="token keyword">for</span> these <span class="token keyword">values</span>?

 <span class="token keyword">WITH</span> avg_delivery_duration <span class="token keyword">AS</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span>
    <span class="token keyword">DISTINCT</span> t2<span class="token punctuation">.</span>runner_id<span class="token punctuation">,</span>
    t2<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    UNNEST<span class="token punctuation">(</span>REGEXP_MATCH<span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token string">'(^[0-9]+)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> :: <span class="token keyword">NUMERIC</span> <span class="token keyword">AS</span> duration<span class="token punctuation">,</span>
    UNNEST<span class="token punctuation">(</span>REGEXP_MATCH<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token string">'(^[0-9,.]+)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> :: <span class="token keyword">NUMERIC</span> <span class="token keyword">AS</span> distance
  <span class="token keyword">FROM</span>
    pizza_runner<span class="token punctuation">.</span>customer_orders <span class="token keyword">AS</span> t1
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> pizza_runner<span class="token punctuation">.</span>runner_orders <span class="token keyword">AS</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>order_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>order_id
  <span class="token keyword">WHERE</span>
    cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
      <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
      <span class="token string">'Customer Cancellation'</span>
    <span class="token punctuation">)</span>
    <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
  runner_id<span class="token punctuation">,</span>
  order_id<span class="token punctuation">,</span>
  duration<span class="token punctuation">,</span>
  distance<span class="token punctuation">,</span>
  <span class="token function">ROUND</span><span class="token punctuation">(</span>distance <span class="token operator">/</span> <span class="token punctuation">(</span>duration<span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_speed
<span class="token keyword">FROM</span>
  avg_delivery_duration
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
  runner_id<span class="token punctuation">,</span>
  order_id<span class="token punctuation">,</span>
  duration<span class="token punctuation">,</span>
  distance
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
  runner_id

<span class="token number">18</span><span class="token punctuation">.</span>  What <span class="token operator">is</span> the successful delivery percentage <span class="token keyword">for</span> each runner?
<span class="token keyword">SELECT</span> 
  runner_id<span class="token punctuation">,</span>
  <span class="token function">ROUND</span><span class="token punctuation">(</span>
    <span class="token number">100</span> <span class="token operator">*</span> <span class="token function">SUM</span><span class="token punctuation">(</span>
      <span class="token keyword">CASE</span>
        <span class="token keyword">WHEN</span>
  cancellation <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token string">'Restaurant Cancellation'</span><span class="token punctuation">,</span>
    <span class="token string">'Customer Cancellation'</span>
  <span class="token punctuation">)</span> <span class="token operator">OR</span> cancellation <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span>
        <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
      <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> successful_delivery_percentage
    <span class="token keyword">FROM</span>
      pizza_runner<span class="token punctuation">.</span>runner_orders
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
      runner_id<span class="token punctuation">;</span>

</code></pre>
</div>
</body>

</html>
